---
- name: Join worker nodes
  hosts: workers
  become: yes
  gather_facts: yes
  vars_files:
    - ../group_vars/all/main.yml
    - ../group_vars/workers/main.yml
  
  tasks:
    - name: Check if node is already joined
      stat:
        path: /etc/kubernetes/kubelet.conf
      register: kubelet_conf

    - name: Join worker to cluster
      command: "{{ hostvars[groups['masters'][0]]['worker_join_command'] }}"
      when: not kubelet_conf.stat.exists